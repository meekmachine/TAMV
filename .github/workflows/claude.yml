name: Claude Code

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

on:
  # Respond to @claude mentions in issues/PRs
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

  # Auto-implement issues (on create or label)
  issues:
    types: [opened, labeled]

  # Auto-review PRs
  pull_request:
    types: [opened, synchronize]

jobs:
  # Respond to @claude mentions
  claude-mention:
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@claude"

  # Auto-implement issues with 'implement' label
  implement-issue:
    if: |
      github.event_name == 'issues' &&
      contains(github.event.issue.labels.*.name, 'implement')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Implement the changes described in this issue.

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            ${{ github.event.issue.body }}

            Instructions:
            1. Read the relevant files to understand the current state
            2. For external GitHub repos, use `gh repo clone` or `gh api` commands (not WebFetch)
            3. Make the necessary code changes using the Edit tool
            4. After making changes, commit them with: git add -A && git commit -m "Fix #${{ github.event.issue.number }}: <description>"
            5. Push to a new branch: git checkout -b issue-${{ github.event.issue.number }} && git push -u origin issue-${{ github.event.issue.number }}
            6. Create a PR using: gh pr create --title "Fix #${{ github.event.issue.number }}: <title>" --body "Closes #${{ github.event.issue.number }}"
          claude_args: "--max-turns 25 --allowedTools Edit,Read,Bash,Glob,Grep,Write,WebFetch"

  # Auto-review PRs
  review-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Review this pull request and provide feedback.

            PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}

            ${{ github.event.pull_request.body }}

            Instructions:
            1. Review the code changes for correctness, style, and potential issues
            2. Check for any security concerns
            3. Verify the changes match the PR description
            4. Post a review comment summarizing your findings
          claude_args: "--max-turns 5"

  # Respond to PR review comments (feedback on Claude's PRs)
  respond-to-pr-feedback:
    if: |
      github.event_name == 'pull_request_review_comment' &&
      !contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            A reviewer left feedback on this pull request. Address their comment.

            PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}

            Review comment from @${{ github.event.comment.user.login }}:
            File: ${{ github.event.comment.path }}
            Line: ${{ github.event.comment.line }}
            Comment: ${{ github.event.comment.body }}

            Instructions:
            1. Understand the reviewer's feedback
            2. If code changes are needed, make them using the Edit tool
            3. Commit and push fixes: git add -A && git commit -m "Address review feedback" && git push
            4. Reply to the comment explaining what you changed (use gh pr comment)
            5. If the feedback is just a question or doesn't require changes, reply with an explanation
          claude_args: "--max-turns 10 --allowedTools Edit,Read,Bash,Glob,Grep,Write"
