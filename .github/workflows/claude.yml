name: Claude Code

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

on:
  # Respond to @claude mentions in issues/PRs
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

  # Auto-implement issues (on create or label)
  issues:
    types: [opened, labeled]

  # Auto-review PRs
  pull_request:
    types: [opened, synchronize]

jobs:
  # Respond to @claude mentions
  claude-mention:
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@claude"

  # Auto-implement issues with 'implement' label
  implement-issue:
    if: |
      github.event_name == 'issues' &&
      contains(github.event.issue.labels.*.name, 'implement')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Implement the changes described in this issue.

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            ${{ github.event.issue.body }}

            Instructions:
            1. Read the relevant files to understand the current state
            2. Make the necessary code changes using the Edit tool
            3. After making changes, commit them with: git add -A && git commit -m "Fix #${{ github.event.issue.number }}: <description>"
            4. Push to a new branch: git checkout -b issue-${{ github.event.issue.number }} && git push -u origin issue-${{ github.event.issue.number }}
            5. Create a PR using: gh pr create --title "Fix #${{ github.event.issue.number }}: <title>" --body "Closes #${{ github.event.issue.number }}"
          claude_args: "--max-turns 15 --allowedTools Edit,Read,Bash,Glob,Grep,Write"

  # Auto-review PRs
  review-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Review this pull request and provide feedback.

            PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}

            ${{ github.event.pull_request.body }}

            Instructions:
            1. Review the code changes for correctness, style, and potential issues
            2. Check for any security concerns
            3. Verify the changes match the PR description
            4. Post a review comment summarizing your findings
          claude_args: "--max-turns 5"
