name: Claude Code

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

on:
  # Respond to @claude mentions in issues/PRs
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

  # Auto-implement issues (on create or label)
  issues:
    types: [opened, labeled]

  # Auto-review PRs
  pull_request:
    types: [opened, synchronize]

jobs:
  # Respond to @claude mentions
  claude-mention:
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          trigger_phrase: "@claude"

  # Auto-implement issues with 'implement' label
  implement-issue:
    if: |
      github.event_name == 'issues' &&
      contains(github.event.issue.labels.*.name, 'implement')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: anthropics/claude-code-action@v1
        continue-on-error: true  # Don't fail workflow if max turns reached
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true  # For debugging
          prompt: |
            Implement the changes described in this issue. Work efficiently and create a PR when done.

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            ${{ github.event.issue.body }}

            Instructions:
            1. Read relevant files quickly to understand the current state
            2. For external GitHub repos, use `gh repo clone` or `gh api` (not WebFetch)
            3. Make code changes using Edit tool
            4. When done: git add -A && git commit -m "Fix #${{ github.event.issue.number }}: <description>"
            5. Create branch and push: git checkout -b issue-${{ github.event.issue.number }} && git push -u origin issue-${{ github.event.issue.number }}
            6. Create PR: gh pr create --title "Fix #${{ github.event.issue.number }}: <title>" --body "Closes #${{ github.event.issue.number }}"
          claude_args: "--max-turns 40 --allowedTools Edit,Read,Bash,Glob,Grep,Write,WebFetch"

  # Auto-review PRs
  review-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Review this pull request and provide feedback.

            PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}

            ${{ github.event.pull_request.body }}

            Instructions:
            1. Review the code changes for correctness, style, and potential issues
            2. Check for any security concerns
            3. Verify the changes match the PR description
            4. Post a review comment summarizing your findings
          claude_args: "--max-turns 5"

  # Respond to line-level PR review comments
  respond-to-pr-review-comment:
    if: |
      github.event_name == 'pull_request_review_comment' &&
      !contains(github.event.comment.body, '@claude') &&
      github.event.comment.user.login != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: anthropics/claude-code-action@v1
        continue-on-error: true
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          prompt: |
            A reviewer left a line comment on this PR. Address their feedback.

            PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}

            Comment from @${{ github.event.comment.user.login }}:
            File: ${{ github.event.comment.path }}
            Line: ${{ github.event.comment.line }}
            Comment: ${{ github.event.comment.body }}

            Instructions:
            1. If code changes needed, make them with Edit tool
            2. Commit and push: git add -A && git commit -m "Address review: ${{ github.event.comment.path }}" && git push
            3. Reply using: gh pr comment ${{ github.event.pull_request.number }} --body "Done: <explanation>"
          claude_args: "--max-turns 15 --allowedTools Edit,Read,Bash,Glob,Grep,Write"

  # Respond to regular PR comments (not line-level)
  respond-to-pr-comment:
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      !contains(github.event.comment.body, '@claude') &&
      github.event.comment.user.login != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR branch
        id: pr
        run: |
          PR_DATA=$(gh pr view ${{ github.event.issue.number }} --json headRefName)
          echo "branch=$(echo $PR_DATA | jq -r '.headRefName')" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout PR branch
        run: git checkout ${{ steps.pr.outputs.branch }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - uses: anthropics/claude-code-action@v1
        continue-on-error: true
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          prompt: |
            A user commented on this PR. Respond appropriately.

            PR #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

            Comment from @${{ github.event.comment.user.login }}:
            ${{ github.event.comment.body }}

            Instructions:
            1. If they're asking for changes, make them with Edit tool
            2. If making changes, commit and push: git add -A && git commit -m "Address feedback" && git push
            3. Reply using: gh pr comment ${{ github.event.issue.number }} --body "<your response>"
          claude_args: "--max-turns 15 --allowedTools Edit,Read,Bash,Glob,Grep,Write"
